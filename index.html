<!doctype html>
<html lang="ur">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIM Details - Shadow Innovations (Frontend)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --red:#ff3b30;
      --red-dark:#cc3026;
      --bg:#f6f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --glass: rgba(255,255,255,0.8);
    }
    *{box-sizing:border-box}
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0; background:linear-gradient(180deg,#f8fafc, #f2f4f8);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .app{
      width:100%; max-width:900px; background:var(--card); border-radius:12px; box-shadow:0 10px 30px rgba(15,23,42,0.08);
      overflow:hidden;
    }
    header{
      background:var(--red); color:#fff; padding:18px 22px;
      display:flex; align-items:center; justify-content:space-between;
    }
    header h1{margin:0; font-size:18px; font-weight:600}
    header p{margin:0; font-size:13px; opacity:0.9}
    .body{padding:20px 22px}
    .form-row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .input{
      flex:1; min-width:200px;
    }
    input[type="text"]{
      width:100%; padding:12px 14px; border-radius:8px; border:1px solid #e6e9ef; font-size:14px;
      outline:none; background:var(--glass);
    }
    .actions{display:flex; gap:10px; align-items:center; margin-top:12px}
    button.primary{
      background:var(--red); color:#fff; padding:10px 16px; border-radius:8px; border:none; cursor:pointer; font-weight:600;
    }
    button.ghost{
      background:transparent; color:var(--red); border:1px solid #ffd6d4; padding:9px 14px; border-radius:8px; cursor:pointer;
    }
    .hint{color:var(--muted); font-size:13px; margin-top:8px}
    .error{color:#b91c1c; font-size:13px; margin-top:8px}
    .results{margin-top:18px}
    table{width:100%; border-collapse:collapse; margin-top:10px; font-size:14px}
    th,td{padding:10px 8px; border-bottom:1px solid #f1f3f6; text-align:left}
    th{background:#fff; color:#111; font-weight:600; font-size:13px}
    .center{text-align:center}
    .small{font-size:13px; color:var(--muted)}
    .loading{display:inline-block; margin-left:8px; width:14px; height:14px; border-radius:50%; border:2px solid rgba(255,255,255,0.4); border-top-color:#fff; animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Responsive */
    @media (max-width:640px){
      .form-row{flex-direction:column}
      header{flex-direction:column; gap:8px; align-items:flex-start}
    }
  </style>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>
  <div class="app" role="application" aria-label="SIM details checker">
    <header>
      <div>
        <h1>SIM Details</h1>
        <p class="small">Mobile number ya CNIC daal kar registered SIMs check karein</p>
      </div>
      <div class="small">Developed by Shadow Innovations</div>
    </header>

    <div class="body">
      <form id="simForm" autocomplete="off">
        <!-- agar backend se CSRF token chahiye ho to yahan dal dein -->
        <input type="hidden" id="csrf_token" value="">

        <div class="form-row">
          <div class="input">
            <input id="mobile" name="mobile" type="text" placeholder="Mobile Number (e.g., 03338570120)" />
          </div>
          <div class="input">
            <input id="cnic" name="cnic" type="text" placeholder="CNIC (e.g., 410036000817340) — bina dashes" />
          </div>
        </div>

        <div class="actions">
          <button id="searchBtn" class="primary" type="submit">Search <span id="spinner" style="display:none" class="loading"></span></button>
          <button id="clearBtn" class="ghost" type="button">Clear</button>
          <button id="downloadBtn" class="ghost" type="button">Download Result PNG</button>
        </div>

        <div id="msg" class="hint">Aap mobile number ya CNIC me se koi aik daalein — dono nahin.</div>
        <div id="error" class="error" style="display:none"></div>
      </form>

      <div id="results" class="results" aria-live="polite"></div>
    </div>
  </div>

  <script>
    // ---- Configuration: replace with your real API endpoint ----
    const API_URL = '/api/sim-details'; // <-- change this to your real endpoint

    // Expected response format (example):
    // {
    //   "success": true,
    //   "data": [
    //     { "operator":"Jazz", "msisdn":"0333xxxxxxx", "sim_type":"Prepaid", "registered_on":"2023-09-01", "imei":"..." },
    //     ...
    //   ]
    // }

    const form = document.getElementById('simForm');
    const mobileEl = document.getElementById('mobile');
    const cnicEl = document.getElementById('cnic');
    const msgEl = document.getElementById('msg');
    const errorEl = document.getElementById('error');
    const resultsEl = document.getElementById('results');
    const searchBtn = document.getElementById('searchBtn');
    const spinner = document.getElementById('spinner');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearBtn = document.getElementById('clearBtn');

    function showError(text){
      errorEl.style.display='block';
      errorEl.textContent = text;
    }
    function clearError(){
      errorEl.style.display='none';
      errorEl.textContent = '';
    }

    function validateInputs(mobile, cnic){
      if(!mobile && !cnic){
        showError('Mobile number ya CNIC me se koi aik zaroori hai.');
        return false;
      }
      if(mobile && !/^(03\d{9}|9\d{9}|\+?92\d{10}|0\d{10})$/.test(mobile.replace(/\s+/g,''))){
        // permissive regex (adjust to your format)
        showError('Mobile number ka format ghalat hai. Example: 03338570120');
        return false;
      }
      if(cnic && !/^\d{13}$/.test(cnic.replace(/-/g,''))){
        showError('CNIC 13 digits hona chahiye (bina dashes). Example: 410036000817340');
        return false;
      }
      clearError();
      return true;
    }

    function renderTable(data){
      if(!Array.isArray(data) || data.length===0){
        resultsEl.innerHTML = '<div class="small">Koi record nahin mila.</div>';
        return;
      }
      let html = '<div id="resultTableWrap"><table id="resultTable" role="table"><thead><tr><th>Operator</th><th>Number</th><th>SIM Type</th><th>Registered On</th><th>IMEI</th></tr></thead><tbody>';
      data.forEach(r=>{
        html += `<tr>
          <td>${escapeHtml(r.operator||'—')}</td>
          <td>${escapeHtml(r.msisdn||r.number||'—')}</td>
          <td>${escapeHtml(r.sim_type||r.type||'—')}</td>
          <td>${escapeHtml(r.registered_on||r.date||'—')}</td>
          <td>${escapeHtml(r.imei||'—')}</td>
        </tr>`;
      });
      html += '</tbody></table></div>';
      resultsEl.innerHTML = html;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];});
    }

    async function doSearch(e){
      if(e) e.preventDefault();
      const mobile = mobileEl.value.trim();
      const cnic = cnicEl.value.trim();

      if(!validateInputs(mobile, cnic)) return;

      // prepare payload
      const payload = {};
      if(mobile) payload.mobile = mobile;
      if(cnic) payload.cnic = cnic;

      // include csrf if present
      const csrf_token = document.getElementById('csrf_token')?.value;
      const headers = { 'Content-Type':'application/json' };
      if(csrf_token) headers['X-CSRF-Token'] = csrf_token;

      // UI: start loading
      spinner.style.display='inline-block';
      searchBtn.disabled = true;
      clearError();
      msgEl.textContent = 'Searching...';

      try {
        const resp = await fetch(API_URL, {
          method:'POST',
          headers,
          body: JSON.stringify(payload)
        });

        if(!resp.ok){
          const text = await resp.text();
          throw new Error(`Server returned ${resp.status}: ${text}`);
        }

        const json = await resp.json();
        if(json.success === false){
          // API-level error
          showError(json.message || 'Server returned an error.');
          resultsEl.innerHTML = '';
        } else {
          // render data (assume json.data array)
          renderTable(json.data || []);
          msgEl.textContent = `Results: ${Array.isArray(json.data)? json.data.length : '—'}`;
        }

      } catch(err){
        console.error(err);
        showError('Request failed — check console and API endpoint. ' + (err.message||''));
        resultsEl.innerHTML = '';
      } finally{
        spinner.style.display='none';
        searchBtn.disabled = false;
      }
    }

    // Download table as PNG
    downloadBtn.addEventListener('click', async () => {
      const tableWrap = document.getElementById('resultTableWrap');
      if(!tableWrap){
        alert('Koi result table maujood nahin hai.');
        return;
      }
      try {
        const canvas = await html2canvas(tableWrap, {scale:2, backgroundColor:'#fff'});
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = `sim-details-${Date.now()}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch(err){
        console.error(err);
        alert('PNG generate karne me error. Console dekhein.');
      }
    });

    clearBtn.addEventListener('click', () => {
      mobileEl.value = '';
      cnicEl.value = '';
      resultsEl.innerHTML = '';
      clearError();
      msgEl.textContent = 'Mobile number ya CNIC daal kar registered SIMs check karein';
    });

    form.addEventListener('submit', doSearch);

    // Optional: allow Enter in inputs to submit
    mobileEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(); }});
    cnicEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(); }});
  </script>
</body>
</html>
